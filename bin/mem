#!/bin/bash

# DontForget Bash Version - AI Second Brain with Ollama and SQLite

DB_DIR="$HOME/memory/.memory"
mkdir -p "$DB_DIR"
DB_FILE="$DB_DIR/dontforget.db"
OLLAMA_URL="http://localhost:11434/api/generate"
MODEL="mistral"  # Default model, can be changed

# Function to initialize database
init_db() {
    sqlite3 "$DB_FILE" <<EOF
CREATE TABLE IF NOT EXISTS notes (
    id INTEGER PRIMARY KEY,
    content TEXT NOT NULL,
    tags TEXT,
    priority INTEGER DEFAULT 0,
    category TEXT DEFAULT 'general',
    due_date TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE VIRTUAL TABLE IF NOT EXISTS notes_fts USING fts5(content, tags, content=notes, content_rowid=id);
EOF
    # Add columns if not exist
    sqlite3 "$DB_FILE" "ALTER TABLE notes ADD COLUMN priority INTEGER DEFAULT 0;" 2>/dev/null || true
    sqlite3 "$DB_FILE" "ALTER TABLE notes ADD COLUMN category TEXT DEFAULT 'general';" 2>/dev/null || true
    sqlite3 "$DB_FILE" "ALTER TABLE notes ADD COLUMN due_date TEXT;" 2>/dev/null || true
}

# Function to call Ollama
call_ollama() {
    local prompt="$1"
    # Use Ollama API with curl
    local response=$(curl -s --max-time 30 "${OLLAMA_URL/api\/generate/api/chat}" -d "{\"model\": \"$MODEL\", \"messages\": [{\"role\": \"user\", \"content\": \"$prompt\"}], \"stream\": false}")
    echo "$response" | jq -r '.message.content // empty' 2>/dev/null || echo ""
}

# Function to remember
remember() {
    local provided_priority=""
    local content=""
    while [ $# -gt 0 ]; do
        case $1 in
            -p) provided_priority="$2"; shift 2 ;;
            *) content="$*"; break ;;
        esac
    done
    if [ -z "$content" ]; then
        echo "Opening editor for long input..."
        content=$(mktemp)
        ${EDITOR:-nano} "$content"
        content=$(cat "$content")
        rm "$content"
    fi

    echo "Generating tags..."
    local tags_prompt="Generate concise tags for this note. Tags should be comma-separated concepts or keywords: $content"
    local tags=$(call_ollama "$tags_prompt" | tr -d '\n')
    tags=$(echo "$tags" | sed "s/'/''/g")

    local priority=0
    if echo "$content" | grep -i urgent >/dev/null; then priority=1; fi
    if echo "$content" | grep -i important >/dev/null; then priority=2; fi
    # Override with provided priority
    if [ -n "$provided_priority" ]; then priority="$provided_priority"; fi

    sqlite3 "$DB_FILE" <<EOF
INSERT INTO notes (content, tags, priority, category, due_date) VALUES ('$content', '$tags', $priority, '$category', '$due_date');
INSERT INTO notes_fts (rowid, content, tags) VALUES (last_insert_rowid(), '$content', '$tags');
EOF

    echo "ðŸ§  Saved! [Tags: $tags]"
}

# Function to query
query() {
    local query="$1"
    if [ -z "$query" ]; then
        echo "Usage: $0 q \"your query\""
        return 1
    fi

    local keywords_prompt="Extract the key search terms from this query: $query. Return only the terms, separated by spaces."
    local keywords=$(call_ollama "$keywords_prompt" | tr -d '[:punct:]' | xargs)
    if [ -z "$keywords" ]; then keywords=$(echo "$query" | tr -d '[:punct:]'); fi
    local search_query=$(echo "$keywords" | sed 's/ / OR /g')


    local date_ref=""
    if echo "$query" | grep -i tomorrow > /dev/null; then
        date_ref="tomorrow"
    else
        date_ref="none"
    fi

    local date_filter=""
    if [ "$date_ref" = "tomorrow" ]; then
        tomorrow=$(date -d 'tomorrow' +%Y-%m-%d)
        date_filter="AND n.timestamp LIKE '$tomorrow%'"
    elif [ "$date_ref" != "none" ] && [ -n "$date_ref" ]; then
        date_filter="AND n.timestamp LIKE '$date_ref%'"
    fi

    local results=$(sqlite3 "$DB_FILE" <<EOF
SELECT n.content, n.tags, n.priority, n.category, n.due_date, n.timestamp FROM notes n JOIN notes_fts ON n.id = notes_fts.rowid
WHERE notes_fts MATCH '$search_query' $date_filter
ORDER BY rank LIMIT 5;
EOF
)
    if [ -z "$results" ]; then
        echo "No matching notes found."
        return
    fi

    local current_date=$(date +%Y-%m-%d)
    local synthesis_prompt="Current date: $current_date\nQuery: $query\nNotes:\n$results\nAnswer:"
    local answer=$(call_ollama "$synthesis_prompt")

    local today=$(date +%Y-%m-%d)
    if [ -n "$answer" ]; then
        echo "$answer"
        echo ""
    fi
    echo "Relevant notes:"
    echo "$results" | awk -F'|' -v today="$today" '
{
    content = $1
    tags = $2
    priority = $3
    category = $4
    due_date = $5
    timestamp = $6
    due_info = ""
    if (due_date != "") {
        if (due_date == today) {
            due_info = " (Due today!)"
        } else if (due_date < today) {
            due_info = " (Overdue: " due_date ")"
        } else {
            due_info = " (Due: " due_date ")"
        }
    }
    print "- " content " (Priority: " priority ", Category: " category due_info ")"
}'
}

# Function to delete
delete() {
    local description="$1"
    if [ -z "$description" ]; then
        echo "Usage: $0 d \"description of note to delete\""
        return 1
    fi

    echo "Identifying note..."
    local all_notes=$(sqlite3 "$DB_FILE" "SELECT id || '|' || REPLACE(content, '''', '''''') FROM notes;")
    local identify_prompt="Identify the note that matches this description: $description. From these notes:\n$all_notes\n\nReturn only the exact content of the matching note."
    local matching_content=$(call_ollama "$identify_prompt" | xargs)

    if [ -z "$matching_content" ]; then
        echo "No matching note found."
        return
    fi

    sqlite3 "$DB_FILE" <<EOF
DELETE FROM notes WHERE content = '$matching_content';
DELETE FROM notes_fts WHERE content = '$matching_content';
EOF

    echo "Deleted note: $matching_content"
}

# Function to check if Ollama is running
check_ollama() {
    if ! curl -s "$OLLAMA_URL" -d '{"model":"'$MODEL'","stream":false,"prompt":"test"}' > /dev/null 2>&1; then
        echo "Error: Ollama server not running or model '$MODEL' not available."
        exit 1
    fi
}

# Main
init_db
check_ollama

list() {
    local notes=$(sqlite3 "$DB_FILE" "SELECT id, content, tags, priority, category, due_date FROM notes ORDER BY timestamp DESC;")
    if [ -z "$notes" ]; then
        echo "No notes found."
    else
        echo "All notes:"
        echo "$notes" | while IFS='|' read -r id content tags priority category due_date; do
            tags_display=$(echo "$tags" | sed "s/''/'/g")
            due_info=""
            if [ -n "$due_date" ]; then due_info=" Due: $due_date"; fi
            echo "$id: $content (Tags: $tags_display, Priority: $priority, Category: $category$due_info)"
        done
    fi
}

edit() {
    local id="$1"
    if [ -z "$id" ] || ! [[ "$id" =~ ^[0-9]+$ ]]; then
        echo "Usage: $0 e <id>"
        return 1
    fi

    local current=$(sqlite3 "$DB_FILE" "SELECT content FROM notes WHERE id = $id;")
    if [ -z "$current" ]; then
        echo "Note with ID $id not found."
        return 1
    fi

    echo "Editing note $id. Current: $current"
    local temp_file=$(mktemp)
    echo "$current" > "$temp_file"
    ${EDITOR:-nano} "$temp_file"
    local new_content=$(cat "$temp_file")
    rm "$temp_file"

    if [ "$new_content" = "$current" ]; then
        echo "No changes made."
        return
    fi

    # Generate new tags
    local tags_prompt="Generate concise tags for this note. Tags should be comma-separated concepts or keywords: $new_content"
    local new_tags=$(call_ollama "$tags_prompt" | tr -d '\n')
    new_tags=$(echo "$new_tags" | sed "s/'/''/g")

    sqlite3 "$DB_FILE" <<EOF
UPDATE notes SET content = '$new_content', tags = '$new_tags' WHERE id = $id;
UPDATE notes_fts SET content = '$new_content', tags = '$new_tags' WHERE rowid = $id;
EOF

    echo "Note $id updated."
}

set_priority() {
    local id="$1"
    local priority="$2"
    if [ -z "$id" ] || [ -z "$priority" ] || ! [[ "$id" =~ ^[0-9]+$ ]] || ! [[ "$priority" =~ ^[0-2]$ ]]; then
        echo "Usage: $0 sp <id> <priority> (0=normal, 1=urgent, 2=important)"
        return 1
    fi

    sqlite3 "$DB_FILE" "UPDATE notes SET priority = $priority WHERE id = $id;"
    if [ $? -eq 0 ]; then
        echo "Priority of note $id set to $priority."
    else
        echo "Error updating priority."
    fi
}

stats() {
    local total_notes=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM notes;")
    local oldest=$(sqlite3 "$DB_FILE" "SELECT timestamp FROM notes ORDER BY timestamp ASC LIMIT 1;")
    local newest=$(sqlite3 "$DB_FILE" "SELECT timestamp FROM notes ORDER BY timestamp DESC LIMIT 1;")
    local top_tags=$(sqlite3 "$DB_FILE" "SELECT tags FROM notes;" | tr ',' '\n' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' | sort | uniq -c | sort -nr | head -5)
    local category_counts=$(sqlite3 "$DB_FILE" "SELECT category, COUNT(*) FROM notes GROUP BY category ORDER BY COUNT(*) DESC;")

    echo "Stats:"
    echo "Total notes: $total_notes"
    echo "Oldest note: $oldest"
    echo "Newest note: $newest"
    echo "Top tags:"
    echo "$top_tags" | while read -r count tag; do
        echo "  $tag: $count"
    done
    echo "Categories:"
    echo "$category_counts" | while IFS='|' read -r cat count; do
        echo "  $cat: $count"
    done
}

reminders() {
    local today=$(date +%Y-%m-%d)
    local urgent_notes=$(sqlite3 "$DB_FILE" "SELECT id, content, due_date FROM notes WHERE priority > 0 ORDER BY due_date;")
    if [ -z "$urgent_notes" ]; then
        echo "No urgent notes."
    else
        echo "Urgent notes:"
        echo "$urgent_notes" | while IFS='|' read -r id content due_date; do
            due_info=""
            if [ -n "$due_date" ]; then
                if [ "$due_date" = "$today" ]; then
                    due_info=" (Due today!)"
                elif [ "$due_date" \< "$today" ]; then
                    due_info=" (Overdue: $due_date)"
                else
                    due_info=" (Due: $due_date)"
                fi
            fi
            echo "- ID $id: $content$due_info"
        done
    fi
}

case "$1" in
    r|remember)
        shift
        remember "$@"
        ;;
    q|query)
        shift
        query "$*"
        ;;
    d|delete)
        shift
        delete "$*"
        ;;
    e|edit)
        shift
        edit "$1"
        ;;
    sp|set-priority)
        shift
        set_priority "$1" "$2"
        ;;
    rem|reminders)
        reminders
        ;;
    s|stats)
        stats
        ;;
    l|list)
        list
        ;;
    *)
        echo "Usage: $0 {r|q|d|e|sp|rem|s|l} [args]"
        echo "  r [-p <0-2>] 'note' - Remember a note (optional priority)"
        echo "  q 'query' - Query notes"
        echo "  d 'desc' - Delete note by description"
        echo "  e <id> - Edit note by ID"
        echo "  sp <id> <0-2> - Set priority (0=normal, 1=urgent, 2=important)"
        echo "  rem - Show urgent reminders due today"
        echo "  s - Show stats"
        echo "  l - List all notes"
        ;;
esac

#!/usr/bin/env bash

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

use_backup=true

while [[ $# -gt 0 ]]; do
    case "$1" in
        --no-backup)
            use_backup=false
            shift
            ;;
        *)
            break
            ;;
    esac
done

if [[ "$use_backup" == true ]]; then
    backup_dir=~/backups/config_backup
else
    backup_dir=""
fi

global_excludes=()

# Sync function with backups and delete excluded files
sync_config() {
    local src="$1"
    local dst="$2"
    shift 2
    local excludes=("$@")

    if [[ "$use_backup" == true ]]; then
        mkdir -p "$backup_dir"
        local rsync_opts=(-avh --backup --backup-dir="$backup_dir")
    else
        local rsync_opts=(-avh)
    fi

    # Add delete flags to remove excluded files/dirs from destination
    rsync_opts+=(--delete --delete-excluded)

    for ex in "${excludes[@]}"; do
        rsync_opts+=(--exclude="$ex")
    done

    if [[ -d "$src" ]]; then
        mkdir -p "$dst"
        echo "üîÑ Syncing directory: $src ‚Üí $dst"
        rsync "${rsync_opts[@]}" "$src"/ "$dst"/
    elif [[ -f "$src" ]]; then
        if [[ -d "$dst" ]]; then
            mkdir -p "$dst"
            echo "üîÑ Syncing file: $src ‚Üí $dst/$(basename "$src")"
            rsync "${rsync_opts[@]}" "$src" "$dst"/
        else
            mkdir -p "$(dirname "$dst")"
            echo "üîÑ Syncing file: $src ‚Üí $dst"
            rsync "${rsync_opts[@]}" "$src" "$dst"
        fi
    else
        echo "‚ö†Ô∏è Source does not exist: $src"
        # Create destination if possible
        if [[ "$dst" == */ ]]; then
            mkdir -p "$dst"
            echo "‚ûï Created destination directory: $dst"
        else
            mkdir -p "$(dirname "$dst")"
            touch "$dst"
            echo "‚ûï Created empty destination file: $dst"
        fi
    fi
}

# Show diff of what would change (dry-run), color-coded
diff_config() {
    local src="$1"
    local dst="$2"
    shift 2
    local excludes=("$@")

    local rsync_opts=(-aq --dry-run --out-format="%n" --delete --delete-excluded)

    for ex in "${excludes[@]}"; do
        rsync_opts+=(--exclude="$ex")
    done

    if [[ -d "$src" ]]; then
        rsync_output=$(rsync "${rsync_opts[@]}" "$src"/ "$dst"/)
    elif [[ -f "$src" ]]; then
        rsync_output=$(rsync "${rsync_opts[@]}" "$src" "$dst")
    else
        echo "‚ö†Ô∏è Source does not exist: $src"
        return
    fi

    while IFS= read -r line; do
        if [[ "$line" == */ ]]; then
            echo -e "${BLUE}${line}${NC}"
        else
            echo -e "${GREEN}${line}${NC}"
        fi
    done <<< "$rsync_output"
}

process_txt_file() {
    local file="$1"

    global_excludes=()

    if IFS= read -r first_line < "$file"; then
        if [[ "$first_line" =~ ^#(.+)$ ]]; then
            local excludes_str="${BASH_REMATCH[1]}"
            IFS=',' read -r -a global_excludes <<< "$excludes_str"
            for i in "${!global_excludes[@]}"; do
                global_excludes[$i]=$(echo "${global_excludes[$i]}" | xargs)
            done
        fi
    fi

    local content=$(sed '1d' "$file" | tr '\n' ' ' | tr -s ' ')

    for pair in $content; do
        local path_part="${pair%%,*}"
        local excludes_part="${pair#*,}"

        if [[ "$path_part" == "$pair" ]]; then
            excludes_part=""
        fi

        local src="${path_part%%:*}"
        local dst="${path_part#*:}"

        if [[ -z "$src" || -z "$dst" ]]; then
            echo "‚ö†Ô∏è Invalid pair: $pair"
            continue
        fi

        src="${src/#\~/$HOME}"
        dst="${dst/#\~/$HOME}"

        IFS=',' read -r -a excludes <<< "$excludes_part"
        for i in "${!excludes[@]}"; do
            excludes[$i]=$(echo "${excludes[$i]}" | xargs)
        done

        local all_excludes=("${global_excludes[@]}" "${excludes[@]}")

        if [[ "$MODE" == "diff" ]]; then
            diff_config "$src" "$dst" "${all_excludes[@]}"
        else
            sync_config "$src" "$dst" "${all_excludes[@]}"
        fi
    done
}

main() {
    if [[ "$1" == "diff" ]]; then
        shift
        MODE="diff"
        if [[ ! -f files.txt ]]; then
            echo "‚ùå files.txt not found"
            exit 1
        fi
        process_txt_file files.txt
    elif [[ "$1" == *.txt ]]; then
        MODE="sync"
        process_txt_file "$1"
    elif [[ $# -eq 2 ]]; then
        MODE="sync"
        local src="${1/#\~/$HOME}"
        local dst="${2/#\~/$HOME}"
        sync_config "$src" "$dst"
    else
        echo "‚ùå Usage:"
        echo "  $0 [--no-backup] source_path destination_path"
        echo "  $0 [--no-backup] links.txt   # with src:dst,exclude1,exclude2 ..."
        echo "  $0 [--no-backup] diff        # run diff on files.txt"
        exit 1
    fi
}

main "$@"

